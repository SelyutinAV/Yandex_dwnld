<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç API –æ—á–µ—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∑–æ–∫</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üîç –¢–µ—Å—Ç API –æ—á–µ—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∑–æ–∫</h1>

    <div id="status" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

    <div>
        <button onclick="testAPI()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="testStartDownload()">üöÄ –¢–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</button>
        <button onclick="clearCache()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞</button>
    </div>

    <div id="results"></div>

    <script>
        async function testAPI() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            try {
                statusDiv.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';
                statusDiv.className = 'status info';

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º API –æ—á–µ—Ä–µ–¥–∏
                const queueResponse = await fetch('http://localhost:8000/api/downloads/queue', {
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const queueData = await queueResponse.json();

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const statsResponse = await fetch('http://localhost:8000/api/downloads/stats', {
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const statsData = await statsResponse.json();

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π endpoint
                const debugResponse = await fetch('http://localhost:8000/api/debug/queue', {
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const debugData = await debugResponse.json();

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π endpoint –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const progressResponse = await fetch('http://localhost:8000/api/downloads/progress', {
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const progressData = await progressResponse.json();

                statusDiv.textContent = '‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!';
                statusDiv.className = 'status success';

                resultsDiv.innerHTML = `
                    <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>
                    
                    <h3>–û—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–æ–∫:</h3>
                    <pre>${JSON.stringify(queueData, null, 2)}</pre>
                    
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
                    <pre>${JSON.stringify(statsData, null, 2)}</pre>
                    
                    <h3>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
                    <pre>${JSON.stringify(debugData, null, 2)}</pre>
                    
                    <h3>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏:</h3>
                    <pre>${JSON.stringify(progressData, null, 2)}</pre>
                    
                    <div class="status ${queueData.queue && queueData.queue.length > 0 ? 'success' : 'error'}">
                        ${queueData.queue && queueData.queue.length > 0
                        ? `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${queueData.queue.length} —Ç—Ä–µ–∫–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏`
                        : '‚ùå –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ –∏–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'}
                    </div>
                    
                    <h3>üìä –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–µ–∫–æ–≤:</h3>
                    <div class="status info">
                        ${debugData.status_counts ?
                        Object.entries(debugData.status_counts).map(([status, count]) =>
                            `${status}: ${count}`
                        ).join(' | ')
                        : '–°—Ç–∞—Ç—É—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'}
                    </div>
                    
                    <h3>üéØ –ì–æ—Ç–æ–≤—ã–µ –∫ –∑–∞–≥—Ä—É–∑–∫–µ:</h3>
                    <div class="status ${debugData.status_counts && debugData.status_counts.queued > 0 ? 'success' : 'error'}">
                        ${debugData.status_counts && debugData.status_counts.queued > 0
                        ? `‚úÖ ${debugData.status_counts.queued} —Ç—Ä–µ–∫–æ–≤ –≥–æ—Ç–æ–≤—ã –∫ –∑–∞–≥—Ä—É–∑–∫–µ (—Å—Ç–∞—Ç—É—Å: queued)`
                        : '‚ùå –ù–µ—Ç —Ç—Ä–µ–∫–æ–≤ –≥–æ—Ç–æ–≤—ã—Ö –∫ –∑–∞–≥—Ä—É–∑–∫–µ'}
                    </div>
                `;

            } catch (error) {
                statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                statusDiv.className = 'status error';
                resultsDiv.innerHTML = `<pre>–û—à–∏–±–∫–∞: ${error.message}</pre>`;
            }
        }

        async function testStartDownload() {
            try {
                const response = await fetch('http://localhost:8000/api/download/queue/start', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();

                document.getElementById('status').textContent = `üöÄ ${data.message}`;
                document.getElementById('status').className = 'status success';

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(testAPI, 2000);

            } catch (error) {
                document.getElementById('status').textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${error.message}`;
                document.getElementById('status').className = 'status error';
            }
        }

        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            window.location.reload(true);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = testAPI;
    </script>
</body>

</html>