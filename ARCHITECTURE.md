# Архитектура приложения

## Обзор

Yandex Music Downloader - это full-stack приложение для загрузки музыки из Яндекс.Музыки с веб-интерфейсом.

```
┌─────────────────────────────────────────────────────────┐
│                    Browser (Frontend)                    │
│                  React + TypeScript                      │
└──────────────────────┬──────────────────────────────────┘
                       │ HTTP/REST API
                       │
┌──────────────────────▼──────────────────────────────────┐
│                  Backend (FastAPI)                       │
│                      Python                              │
├──────────────────────────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐  ┌─────────────┐       │
│  │   Routes   │  │  Yandex    │  │  Download   │       │
│  │  (REST)    │  │  Client    │  │  Manager    │       │
│  └────────────┘  └────────────┘  └─────────────┘       │
│                                                          │
│  ┌────────────────────────────────────────────┐         │
│  │         Database (SQLite)                   │         │
│  │  - Tracks  - Playlists  - Queue            │         │
│  └────────────────────────────────────────────┘         │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ API requests
                       │
┌──────────────────────▼──────────────────────────────────┐
│              Yandex.Music API                            │
└──────────────────────────────────────────────────────────┘
```

## Frontend (React + TypeScript)

### Структура компонентов

```
src/
├── App.tsx                 # Главный компонент приложения
├── main.tsx               # Точка входа
├── index.css              # Глобальные стили
└── components/
    ├── PlaylistManager.tsx    # Управление плейлистами
    ├── DownloadQueue.tsx      # Очередь загрузок
    ├── FileAnalyzer.tsx       # Анализ файлов
    └── SettingsPanel.tsx      # Настройки
```

### Основные возможности

1. **PlaylistManager** - Отображение и выбор плейлистов
   - Загрузка плейлистов с API
   - Выбор нескольких плейлистов
   - Запуск синхронизации
   - Отображение статуса синхронизации

2. **DownloadQueue** - Мониторинг загрузок
   - Отображение текущих загрузок
   - Прогресс-бары
   - Управление очередью
   - Статистика загрузок

3. **FileAnalyzer** - Анализ коллекции
   - Статистика по форматам
   - Статистика по качеству
   - Размер коллекции
   - Последние загрузки

4. **SettingsPanel** - Конфигурация
   - Авторизация в Яндекс.Музыке
   - Настройка путей
   - Выбор качества
   - Автосинхронизация

### Технологии

- **React 18** - UI библиотека
- **TypeScript** - типизация
- **Vite** - сборщик и dev-server
- **Lucide React** - иконки
- **Axios** - HTTP клиент

## Backend (Python + FastAPI)

### Структура модулей

```
backend/
├── main.py              # FastAPI приложение и роуты
├── yandex_client.py     # Клиент для Яндекс.Музыки
├── downloader.py        # Менеджер загрузок
├── database.py          # Модели БД и ORM
├── requirements.txt     # Зависимости Python
└── env.example          # Пример настроек
```

### Модули

#### main.py - API endpoints

- `GET /api/playlists` - Получить плейлисты пользователя
- `GET /api/playlists/{id}/tracks` - Получить треки плейлиста
- `POST /api/download` - Начать загрузку
- `GET /api/downloads` - Статус загрузок
- `GET /api/files/stats` - Статистика файлов
- `POST /api/auth/test` - Проверка токена
- `GET/POST /api/settings` - Настройки

#### yandex_client.py - Работа с API

Обертка над библиотекой `yandex-music`:

- Авторизация через токен
- Получение плейлистов
- Получение треков
- Загрузка аудио в разных качествах
- Получение метаданных

#### downloader.py - Управление загрузками

- Асинхронная загрузка треков
- Организация файлов по папкам
- Добавление метаданных (ID3, FLAC tags)
- Анализ существующих файлов
- Прогресс загрузки

#### database.py - Хранилище данных

**Таблицы:**

1. `downloaded_tracks` - Скачанные треки
   - ID трека, название, исполнитель
   - Путь к файлу, размер, формат
   - Дата загрузки

2. `playlist_syncs` - Синхронизация плейлистов
   - ID плейлиста, название
   - Дата последней синхронизации
   - Настройки автосинхронизации

3. `download_queue` - Очередь загрузок
   - Информация о треке
   - Статус (pending/downloading/completed/error)
   - Прогресс

4. `settings` - Настройки приложения
   - Ключ-значение пары

### Технологии

- **FastAPI** - веб-фреймворк
- **yandex-music** - библиотека для API Яндекс.Музыки
- **SQLAlchemy** - ORM
- **SQLite** - база данных
- **Mutagen** - работа с аудио метаданными
- **aiofiles** - асинхронная работа с файлами

## Процесс загрузки

### 1. Инициализация

```
Пользователь → Настройки → Ввод токена → Проверка подключения
```

### 2. Выбор плейлистов

```
Frontend: Запрос плейлистов
    ↓
Backend: Запрос к Яндекс.Музыке API
    ↓
Yandex API: Возврат списка плейлистов
    ↓
Frontend: Отображение плейлистов
    ↓
Пользователь: Выбор плейлистов для синхронизации
```

### 3. Загрузка

```
Frontend: POST /api/download {playlistId, quality}
    ↓
Backend: Получение списка треков плейлиста
    ↓
Backend: Добавление треков в очередь (download_queue)
    ↓
Backend: Асинхронная загрузка треков
    │
    ├─→ Для каждого трека:
    │   ├─ Проверка доступности
    │   ├─ Получение ссылки на аудио
    │   ├─ Загрузка файла
    │   ├─ Добавление метаданных
    │   ├─ Сохранение в БД
    │   └─ Обновление прогресса
    │
    ↓
Backend: Возврат статуса
    ↓
Frontend: Отображение прогресса в реальном времени
```

### 4. Анализ файлов

```
Frontend: GET /api/files/stats
    ↓
Backend: Сканирование директории с музыкой
    ↓
Backend: Чтение метаданных файлов
    ↓
Backend: Подсчет статистики
    ↓
Frontend: Отображение графиков и статистики
```

## Качество аудио

### Уровни качества

1. **lossless** (рекомендуется)
   - Формат: FLAC
   - Битрейт: до 24-bit/96kHz
   - Размер: ~50-100 МБ на трек
   - Для: Аудиофильское оборудование

2. **hq** (высокое)
   - Формат: AAC или MP3
   - Битрейт: 320 kbps
   - Размер: ~8-12 МБ на трек
   - Для: Качественные наушники

3. **nq** (нормальное)
   - Формат: MP3
   - Битрейт: 192-256 kbps
   - Размер: ~4-6 МБ на трек
   - Для: Повседневное прослушивание

## Безопасность

### Токен авторизации

- Хранится в `.env` файле (не коммитится в git)
- Передается через заголовки API запросов
- Не отображается в логах

### Файловая система

- Проверка прав доступа к папкам
- Санитизация имен файлов
- Защита от path traversal

## Масштабирование

### Возможные улучшения

1. **Фоновые задачи**
   - Использование Celery + Redis
   - Параллельная загрузка треков
   - Очереди с приоритетами

2. **Кэширование**
   - Redis для кэша API запросов
   - Кэш метаданных треков

3. **WebSocket**
   - Обновление прогресса в реальном времени
   - Уведомления о завершении загрузок

4. **Docker**
   - Контейнеризация приложения
   - docker-compose для простого развертывания

5. **Мониторинг**
   - Prometheus + Grafana для метрик
   - Логирование с ELK stack

## Ограничения API

- Яндекс.Музыка может ограничивать количество запросов
- Рекомендуется добавить задержки между загрузками
- Токен может устареть - нужна периодическая переавторизация

## Лицензионные вопросы

⚠️ **Важно:** Приложение предназначено для **личного использования**. 

- Скачивание музыки разрешено только при наличии **активной подписки**
- Файлы должны использоваться только в **личных целях**
- **Запрещено** распространение скачанных файлов
- Соблюдайте **правила сервиса** Яндекс.Музыки

