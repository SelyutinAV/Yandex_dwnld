# Обновление: network_mode: host для улучшения производительности

## Что изменилось

1. **Добавлен `network_mode: host`** - контейнер теперь использует сеть хоста напрямую
2. **Закомментированы `ports`** - с host network порты не маппятся через Docker
3. **Изменен `FRONTEND_URL` по умолчанию** - с `:7777` на `:8000`

## Преимущества

- ✅ Скорость загрузки такая же, как на хосте
- ✅ Без ограничений Docker bridge сети
- ✅ Более стабильное соединение
- ✅ Быстрая загрузка файлов из Яндекс.Музыки

## ⚠️ ВАЖНО: Изменился порт доступа!

**Раньше:** `http://192.168.1.80:7777`  
**Теперь:** `http://192.168.1.80:8000`

С `network_mode: host` приложение слушает напрямую на порту 8000 (или тот, что указан в `API_PORT`).

## Инструкция по применению на Synology

### Шаг 1: Обновите код из GitHub

```bash
cd /volume1/docker/yandex-downloads
git pull origin main
```

### Шаг 2: Остановите контейнер

```bash
docker-compose down
```

### Шаг 3: Проверьте .env файл (если есть)

Если у вас есть `.env` файл, убедитесь что `FRONTEND_URL` использует порт 8000:

```env
FRONTEND_URL=http://192.168.1.80:8000
```

**Альтернатива:** Если хотите использовать порт 7777, измените `API_PORT` в `.env`:

```env
API_PORT=7777
FRONTEND_URL=http://192.168.1.80:7777
```

**Примечание:** Изменение `API_PORT` потребует изменения кода приложения. Рекомендуется использовать порт 8000.

### Шаг 4: Пересоберите и запустите контейнер

```bash
docker-compose build --no-cache
docker-compose up -d
```

### Шаг 5: Проверьте логи

```bash
docker-compose logs -f yandex-music-downloader
```

Убедитесь, что приложение запустилось без ошибок.

### Шаг 6: Откройте приложение

Откройте в браузере: **http://192.168.1.80:8000**

### Шаг 7: Проверьте загрузку

Попробуйте загрузить несколько треков и проверьте скорость - она должна быть такой же, как на хосте!

## Ожидаемый результат

- ✅ Скорость загрузки такая же, как на хосте (быстрая!)
- ✅ Без ошибок `BrokenPipeError`
- ✅ Стабильное соединение
- ✅ Быстрая загрузка файлов из Яндекс.Музыки

## Если что-то пошло не так

### Проблема: Порт 8000 занят

Если порт 8000 занят, вы можете:

1. **Изменить `API_PORT` в `.env`:**
   ```env
   API_PORT=7777
   FRONTEND_URL=http://192.168.1.80:7777
   ```
   Но это потребует изменения кода приложения.

2. **Освободить порт 8000:**
   Проверьте, что использует порт 8000:
   ```bash
   sudo netstat -tulpn | grep :8000
   ```

### Проблема: Контейнер не запускается

Проверьте логи:
```bash
docker-compose logs yandex-music-downloader
```

Убедитесь, что:
- Порт 8000 свободен
- `.env` файл корректный
- Все volumes доступны

### Откат изменений (если нужно)

Если нужно вернуться к старой конфигурации:

```bash
git checkout HEAD~1 docker-compose.yml
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## Технические детали

### Что такое `network_mode: host`?

С `network_mode: host` контейнер использует сетевой стек хоста напрямую, без Docker bridge сети. Это означает:

- ✅ Лучшая производительность (нет overhead Docker bridge)
- ✅ Прямой доступ к сети хоста
- ✅ Нет проблем с DNS внутри контейнера
- ⚠️ Порты не маппятся через Docker
- ⚠️ Приложение слушает напрямую на указанном порту

### Почему это должно помочь?

На Synology Docker bridge сеть может иметь ограничения производительности. Использование `network_mode: host` устраняет эти ограничения и позволяет контейнеру работать с сетью хоста напрямую.

